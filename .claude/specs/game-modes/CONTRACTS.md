# Game Modes & Flow Contracts

**Version:** 1.0
**Last Updated:** 2025-11-16
**Source:** `src/types.ts`

---

## Overview

This document defines all TypeScript interfaces used by the game modes system. These contracts enable game mode orchestration, race configuration, career progression, and state management.

**Key Principle:** Game modes orchestrate, they don't implement. All interfaces coordinate existing systems.

---

## Core Orchestration Interfaces

### RaceConfig

**Purpose:** Configure a complete race with all necessary parameters.

**Definition:**
```typescript
export interface RaceConfig {
  track: Track;             // Track to race on
  laps: number;             // Number of laps
  playerDriver: Driver;     // Player's driver
  aiDrivers: Driver[];      // AI competitor drivers
  startingPosition?: number; // Player starting position (random if not specified)
}
```

**Usage:**
- Passed to RaceEngine to initialize race
- Defines complete race setup
- Used by both single race and career modes

**Validation Rules:**
- `laps` must be > 0
- `aiDrivers` should be 1-39 drivers (40 total with player)
- `startingPosition` if provided must be 1-40
- All drivers must have unique IDs

**Example:**
```typescript
const config: RaceConfig = {
  track: bristolTrack,
  laps: 500,
  playerDriver: myDriver,
  aiDrivers: generateAIField(39, 'mixed'),
  startingPosition: 7
};
```

---

### RaceState

**Purpose:** Complete snapshot of current race state for display and decision-making.

**Definition:**
```typescript
export interface RaceState {
  currentLap: number;       // Current lap number
  totalLaps: number;        // Total laps in race
  positions: Position[];    // Current race order
  leaderLapTime: number;    // Leader's last lap time
  playerPosition: number;   // Player's current position
  playerDriver: Driver;     // Player driver state
  playerCar: CarState;      // Player car state
  track: Track;             // Track being raced on
  activeDecision: Decision | null; // Pending decision (if any)
  raceEvents: RaceEvent[];  // Recent race events
  caution: boolean;         // Caution flag status
  lapProgress: LapProgress[]; // Real-time lap progress for all drivers
}
```

**Usage:**
- Returned by `RaceEngine.getCurrentState()`
- Passed to `UIRenderer.render(state)`
- Immutable snapshot (UI never modifies)
- Generated fresh each display cycle

**Read-Only:** UI and other systems consume this data, never mutate it.

---

### RaceResults

**Purpose:** Complete race summary after completion.

**Definition:**
```typescript
export interface RaceResults {
  finishPosition: number;   // Final position
  startPosition: number;    // Starting position
  positionsGained: number;  // Net positions gained/lost
  lapsLed: number;          // Laps led
  lapsCompleted: number;    // Laps completed
  fastestLap: number;       // Fastest lap time
  averageLap: number;       // Average lap time
  cleanLaps: number;        // Laps without incidents
  decisionsTotal: number;   // Total decisions made
  decisionsCorrect: number; // Good decisions
  xpGained: XPGain[];       // XP breakdown by skill
}
```

**Usage:**
- Generated by RaceEngine at race completion
- Passed to UIRenderer.showResults()
- Used for career mode to award XP and points
- Stored in career history

**XP Award Calculation:**
- Based on finish position, laps led, clean laps, decision quality
- Calculated by character system, not game modes
- Game modes just pass results to character system

---

## Career Mode Interfaces

### CareerSave

**Purpose:** Complete career state for save/load persistence.

**Definition:**
```typescript
export interface CareerSave {
  driverId: string;         // Player driver ID
  driver: Driver;           // Driver state (skills, mental state, stats)
  season: number;           // Current season
  race: number;             // Current race in season
  points: number;           // Championship points
  unlockedTracks: string[]; // Track IDs unlocked
  raceHistory: RaceResults[]; // Past race results
}
```

**Persistence:**
- Saved to JSON file: `saves/career-{driverId}.json`
- Backup created before each save: `career-{driverId}-backup.json`
- Auto-saved after each race
- Loaded on career continue

**State Restoration:**
```typescript
// Load career
const save: CareerSave = JSON.parse(saveFileContent);
const driver = save.driver; // Restore driver with all skills, stats
const season = save.season; // Resume at current season
const race = save.race;     // Next race to run
```

**Validation:**
- All fields required
- `raceHistory` length should match completed races
- `points` should be calculable from history
- `unlockedTracks` should match progression rules

---

## Race Loop Interfaces

### Position

**Purpose:** Individual driver position and timing data during race.

**Definition:**
```typescript
export interface Position {
  position: number;         // Current position (1-40)
  driverId: string;         // Driver ID
  driverName: string;       // Driver name
  lapTime: number;          // Last lap time in seconds
  gapToLeader: number;      // Gap to leader in seconds
  gapToNext: number;        // Gap to car ahead in seconds
  lapsLed: number;          // Laps led this race
}
```

**Usage:**
- Array of positions in RaceState
- Updated each lap by RaceEngine
- Sorted by position (1st, 2nd, 3rd, etc.)

---

### RaceEvent

**Purpose:** Track significant race moments.

**Definition:**
```typescript
export interface RaceEvent {
  lap: number;              // Lap number when occurred
  type: string;             // Event type
  description: string;      // Human-readable description
  driversInvolved: string[]; // Driver IDs involved
  severity?: 'minor' | 'major' | 'critical';
}
```

**Event Types:**
- `pass` - Successful pass attempt
- `incident` - Collision or spin
- `pit-stop` - Driver pitted
- `caution` - Yellow flag
- `milestone` - Laps led, position change

**Usage:**
- Added to RaceState.raceEvents array
- Displayed in race feed or ticker
- Affects mental state (incidents increase frustration)

---

### LapProgress

**Purpose:** Real-time lap completion tracking.

**Definition:**
```typescript
export interface LapProgress {
  driverId: string;         // Driver ID
  progress: number;         // Lap completion (0.0 to 1.0)
}
```

**Usage:**
- Updated every simulation tick (100ms)
- Used for real-time lap progress visualization
- 0.0 = starting lap, 1.0 = lap complete

**Example:**
```typescript
// Driver is 62% through current lap
{ driverId: "player", progress: 0.62 }
```

---

## Championship & Progression

### Championship Points System

**Points Award Table:**

| Position | Points |
|----------|--------|
| 1st | 40 |
| 2nd | 35 |
| 3rd | 34 |
| 4th | 33 |
| ... | ... (decreasing) |
| 40th | 1 |

**Bonus Points:**
- Led a lap: +5
- Most laps led: +5

**Total Points Calculation:**
```typescript
interface PointsAwarded {
  finishPoints: number;     // Based on position
  lapsLedBonus: number;     // +5 if led any laps
  mostLapsLedBonus: number; // +5 if led most laps
  totalPoints: number;      // Sum of above
}
```

**Implementation:**
```typescript
function calculateRacePoints(results: RaceResults, field: Driver[]): PointsAwarded {
  const finishPoints = POINTS_TABLE[results.finishPosition];
  const lapsLedBonus = results.lapsLed > 0 ? 5 : 0;
  const mostLapsLedBonus = results.lapsLed === Math.max(...) ? 5 : 0;

  return {
    finishPoints,
    lapsLedBonus,
    mostLapsLedBonus,
    totalPoints: finishPoints + lapsLedBonus + mostLapsLedBonus
  };
}
```

---

### Track Unlock System

**Unlock Structure:**
```typescript
interface TrackUnlock {
  trackId: string;          // Track to unlock
  unlockCondition: {
    type: 'finish-position' | 'win' | 'milestone';
    requiredTrack?: string;  // Previous track ID
    requiredPosition?: number; // Top N finish required
  };
}
```

**Example Unlock Rules:**
```typescript
const unlockRules: TrackUnlock[] = [
  {
    trackId: 'richmond',
    unlockCondition: {
      type: 'finish-position',
      requiredTrack: 'bristol',
      requiredPosition: 10 // Top 10 at Bristol
    }
  },
  {
    trackId: 'talladega',
    unlockCondition: {
      type: 'win',
      requiredTrack: 'daytona' // Must win at Daytona
    }
  }
];
```

---

## AI Driver Management

### AIDriver

**Purpose:** AI competitor definition extending base Driver.

**Definition:**
```typescript
export interface AIDriver extends Driver {
  personality: AIPersonality; // AI behavior traits
  difficulty: 'rookie' | 'amateur' | 'professional' | 'elite';
}
```

**AIPersonality:**
```typescript
export interface AIPersonality {
  aggression: number;       // 0-100: passive to aggressive
  riskTolerance: number;    // 0-100: safe to risky
  adaptability: number;     // 0-100: stubborn to adaptive
  consistency: number;      // 0-100: erratic to consistent
}
```

**Usage:**
- Generate AI field for races
- AI decision-making based on personality
- Difficulty affects skill ranges

**Field Generation:**
```typescript
function generateAIField(count: number, mixType: 'easy' | 'mixed' | 'hard'): AIDriver[] {
  // Generate count AI drivers with skill distribution based on mixType
  // Easy: more rookies/amateurs
  // Mixed: balanced distribution
  // Hard: more professionals/elite
}
```

---

## Menu System Interfaces

### MenuOption

**Purpose:** Menu item definition.

**Definition:**
```typescript
export interface MenuOption {
  id: string;               // Option ID (returned when selected)
  label: string;            // Display text
  description?: string;     // Optional description
  disabled?: boolean;       // Whether option is available
}
```

**Usage:**
- Main menu options
- Career mode submenu
- Settings menu (future)

**Example:**
```typescript
const mainMenu: MenuOption[] = [
  { id: 'quick-race', label: 'Quick Race', description: 'Single race' },
  { id: 'career', label: 'Career Mode', description: 'Season progression' },
  { id: 'quit', label: 'Quit' }
];
```

---

## State Machine Interfaces

### Race State Machine

**States:**
```typescript
type RacePhase =
  | 'initialized'  // Race config loaded, not started
  | 'running'      // Race in progress
  | 'paused'       // Race paused (decision or user pause)
  | 'completed';   // Race finished
```

**Transitions:**
```typescript
initialized → running (start race)
running → paused (pause() or decision triggered)
paused → running (resume())
running → completed (all laps done or race ended)
```

**State Methods:**
```typescript
interface RaceSimulation {
  initialize(config: RaceConfig): void;
  start(): void;
  pause(): void;
  resume(): void;
  simulateTick(elapsedMs: number): void;
  getCurrentState(): RaceState;
  isComplete(): boolean;
  getResults(): RaceResults;
}
```

---

## Integration Contracts

### Physics Integration

**Game modes use physics interfaces:**
```typescript
calculateLapTime(driver: Driver, car: CarState, track: Track): number
calculateFuelConsumption(track: Track, laps: number): number
calculateTireGrip(initialGrip: number, laps: number): number
```

**Game modes never:**
- Implement physics formulas
- Calculate lap times directly
- Modify physics constants

---

### Character Integration

**Game modes use character interfaces:**
```typescript
awardXP(results: RaceResults, driver: Driver): XPGain[]
updateMentalState(event: RaceEvent, driver: Driver): MentalState
applySkillEffects(skill: DriverSkills): { lapTimeModifier: number }
```

**Game modes never:**
- Calculate XP directly
- Modify skills directly
- Implement mental state formulas

---

### Decision Integration

**Game modes use decision interfaces:**
```typescript
shouldTriggerDecision(state: RaceState): Decision | null
evaluateDecision(decision: Decision, choice: string, driver: Driver): DecisionResult
applyDecisionEffects(result: DecisionResult, state: RaceState): RaceState
```

**Game modes never:**
- Generate decision content
- Evaluate skill checks
- Implement decision formulas

---

## Contract Validation

### Type Safety

All interfaces must pass TypeScript type checking:

```bash
npm run type-check
```

### Runtime Validation

**RaceConfig Validation:**
```typescript
function validateRaceConfig(config: RaceConfig): boolean {
  if (config.laps <= 0) return false;
  if (!config.track || !config.playerDriver) return false;
  if (config.aiDrivers.length === 0 || config.aiDrivers.length > 39) return false;
  if (config.startingPosition && (config.startingPosition < 1 || config.startingPosition > 40)) return false;
  return true;
}
```

**CareerSave Validation:**
```typescript
function validateCareerSave(save: CareerSave): boolean {
  if (!save.driverId || !save.driver) return false;
  if (save.season < 1 || save.race < 1 || save.race > 10) return false;
  if (save.points < 0) return false;
  return true;
}
```

---

## Design Rules

### 1. Orchestration Only

Game modes coordinate, never duplicate:

**Good:**
```typescript
// Game mode orchestrates
const lapTime = calculateLapTime(driver, car, track); // Uses physics
const xp = awardXP(results, driver);                  // Uses character
```

**Bad:**
```typescript
// Game mode reimplements
const lapTime = baseTime * skillFactor * tireFactor; // ❌ Physics duplication
const xp = finishPosition * 10;                      // ❌ Character duplication
```

---

### 2. Immutable State Snapshots

RaceState is read-only outside RaceEngine:

**Good:**
```typescript
const state = engine.getCurrentState();
renderer.render(state); // Read only
```

**Bad:**
```typescript
const state = engine.getCurrentState();
state.currentLap++;  // ❌ Never mutate state snapshot
```

---

### 3. Serializable State

All state must be JSON-serializable:

**Good:**
```typescript
const save: CareerSave = {
  driverId: "player-001",
  driver: driverObject,
  season: 1,
  // ... all plain data
};
JSON.stringify(save); // ✅ Works
```

**Bad:**
```typescript
const save = {
  driverId: "player-001",
  calculatePoints: () => { /* ... */ }, // ❌ Functions not serializable
  driver: new DriverClass()             // ❌ Class instances risky
};
```

---

## Testing Contracts

### Mock Data

Use type-safe mocks in tests:

```typescript
const mockConfig: RaceConfig = {
  track: mockTrack(),
  laps: 500,
  playerDriver: mockDriver(),
  aiDrivers: mockAIField(39),
  startingPosition: 7
};
```

### Contract Compliance

Ensure all implementations match interfaces:

```typescript
const engine: RaceSimulation = new RaceEngine();
// TypeScript ensures all methods exist and signatures match
```

---

## Related Documents

- `SPEC.md` - Game modes overview
- `EXAMPLES.md` - Game flow scenarios
- `REFERENCE.md` - Quick reference
- `src/types.ts` - Source of truth for interfaces

---

**Last Updated:** 2025-11-16
**Next Sync:** When new interfaces added to src/types.ts
