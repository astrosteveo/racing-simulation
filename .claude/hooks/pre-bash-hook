#!/bin/bash
#
# Pre-Bash Hook for NASCAR RPG Racing Simulation
#
# This hook runs before bash commands to enforce quality standards.
# Primary use: Prevent committing broken code (runs tests, type-check, lint before git commit)
#

# Only run checks for git commit commands
if [[ "$BASH_COMMAND" == *"git commit"* ]]; then
  echo ""
  echo "ğŸ” Pre-commit checks running..."
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # 1. Type checking
  echo ""
  echo "ğŸ“‹ Running TypeScript type check..."
  if ! npm run type-check 2>&1 | grep -v "npm WARN"; then
    echo ""
    echo "âŒ Type check failed! Fix type errors before committing."
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    exit 1
  fi
  echo "âœ… Type check passed"

  # 2. Run tests
  echo ""
  echo "ğŸ§ª Running test suite..."
  if ! npm test -- --run --reporter=verbose 2>&1 | grep -E "(PASS|FAIL|âœ“|âœ—|Test Files|Tests)"; then
    echo ""
    echo "âŒ Tests failed! All tests must pass before committing."
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    exit 1
  fi
  echo "âœ… All tests passed"

  # 3. Linting
  echo ""
  echo "ğŸ§¹ Running ESLint..."
  if ! npm run lint 2>&1 | grep -v "npm WARN"; then
    echo ""
    echo "âŒ Linting failed! Fix lint errors before committing."
    echo "   (Run 'npm run lint:fix' to auto-fix some issues)"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    exit 1
  fi
  echo "âœ… Linting passed"

  # All checks passed
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "âœ¨ All pre-commit checks passed! Proceeding with commit..."
  echo ""
fi

# Allow the command to proceed
exit 0
