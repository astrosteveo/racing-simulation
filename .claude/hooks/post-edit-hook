#!/bin/bash
#
# Post-Edit Hook for NASCAR RPG Racing Simulation
#
# This hook runs after editing files to catch issues immediately.
# Focus: Type checking, linting, and breaking change detection
#

FILE_PATH="$1"

# Skip if no file path provided or if it's in node_modules
if [[ -z "$FILE_PATH" ]] || [[ "$FILE_PATH" == *"node_modules"* ]]; then
  exit 0
fi

echo ""
echo "‚úèÔ∏è  Post-edit hook triggered for: $FILE_PATH"

# Check if npm is available
if ! command -v npm &> /dev/null; then
  exit 0
fi

# CRITICAL: types.ts changed - potential breaking change!
if [[ "$FILE_PATH" == *"types.ts"* ]]; then
  echo ""
  echo "‚ö†Ô∏è  ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
  echo "‚ö†Ô∏è  TYPES.TS MODIFIED - POTENTIAL BREAKING CHANGE!"
  echo "‚ö†Ô∏è  ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
  echo ""
  echo "üîç Running full type check across project..."

  if npm run type-check 2>&1 | grep -E "(error TS|‚úì|‚úó)"; then
    echo "‚úÖ No type errors - interfaces still compatible"
  else
    echo ""
    echo "‚ùå TYPE ERRORS DETECTED!"
    echo "   Type changes have broken existing implementations."
    echo "   Review errors above and update affected files."
    echo ""
  fi

  echo ""
  echo "üß™ Running full test suite to verify contract compatibility..."

  if npm test -- --run --reporter=basic 2>&1 | grep -E "(PASS|FAIL|Test Files|Tests)"; then
    echo "‚úÖ All tests still pass - contracts are compatible"
  else
    echo ""
    echo "‚ùå TESTS FAILING AFTER TYPE CHANGE!"
    echo "   Your interface changes broke existing code."
    echo "   This is a breaking change - proceed carefully."
    echo ""
  fi

  echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
  echo "üí° Reminder: Types are contracts. Changes affect ALL implementations."
  echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
  exit 0
fi

# For any TypeScript file
if [[ "$FILE_PATH" == *".ts"* ]]; then

  # Type checking
  echo "üîç Type checking..."
  if npm run type-check 2>&1 | grep -v "npm WARN" | head -10 | grep -E "(error TS|‚úì|‚úó)"; then
    echo "‚úÖ No type errors"
  else
    echo "‚ö†Ô∏è  Type errors found - review above"
  fi

  # Auto-fix linting issues
  echo "üßπ Auto-fixing lint issues..."
  if npm run lint:fix "$FILE_PATH" 2>&1 | grep -v "npm WARN" | tail -5; then
    echo "‚úÖ Linting complete"
  else
    echo "‚ö†Ô∏è  Some lint issues require manual fixes"
  fi

  # If this is implementation code (not a test), check if related tests exist
  if [[ "$FILE_PATH" != *".test.ts"* ]] && [[ "$FILE_PATH" != *".spec.ts"* ]]; then
    # Extract base filename to look for corresponding test
    BASENAME=$(basename "$FILE_PATH" .ts)
    DIRNAME=$(dirname "$FILE_PATH")

    # Try to find corresponding test file
    TEST_FILE_PATTERNS=(
      "tests/unit/**/${BASENAME}.test.ts"
      "tests/unit/**/${BASENAME}.spec.ts"
      "${DIRNAME}/${BASENAME}.test.ts"
    )

    TEST_FOUND=false
    for PATTERN in "${TEST_FILE_PATTERNS[@]}"; do
      if compgen -G "$PATTERN" > /dev/null 2>&1; then
        TEST_FOUND=true
        break
      fi
    done

    if [[ "$TEST_FOUND" == false ]]; then
      echo ""
      echo "üí° No test file found for $BASENAME.ts"
      echo "   Consider: TDD approach requires tests for implementation code"
    else
      echo "‚úÖ Test file exists for this implementation"
    fi
  fi
fi

# For JSON data files
if [[ "$FILE_PATH" == *".json"* ]] && [[ "$FILE_PATH" == *"src/data/"* ]]; then
  echo "üìä Validating JSON syntax..."
  if cat "$FILE_PATH" | python3 -m json.tool > /dev/null 2>&1; then
    echo "‚úÖ Valid JSON syntax"
  else
    echo "‚ùå Invalid JSON syntax - fix before committing"
  fi
fi

echo ""
exit 0
