#!/bin/bash
#
# Pre-commit hook for TDD enforcement
# This hook runs before every commit and blocks if quality checks fail
#
# Location: .git/hooks/pre-commit (installed from .claude/hooks/pre-commit)
# Install: Run `npm run prepare` or `bash scripts/install-hooks.sh`
# Bypass: Use `git commit --no-verify` (only for emergencies!)
#

set -e  # Exit on first error

echo ""
echo "ğŸš¦ Pre-commit Quality Gate"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# Check 1: Run tests
echo "ğŸ“‹ Check 1/3: Running tests..."
if npm run test:run --silent 2>&1 | grep -q "FAIL\|Error"; then
  echo ""
  echo "âŒ COMMIT BLOCKED: Tests are failing"
  echo ""
  echo "   Fix failing tests before committing."
  echo "   Run: npm run test:run (to see failures)"
  echo ""
  echo "   TDD Reminder:"
  echo "   - Did you write the test first?"
  echo "   - Does the test validate the change?"
  echo "   - Are all tests passing?"
  echo ""
  echo "   Bypass (emergency only): git commit --no-verify"
  echo ""
  exit 1
fi
echo "   âœ… All tests passing"
echo ""

# Check 2: Type checking
echo "ğŸ“‹ Check 2/3: Running TypeScript type check..."
if ! npm run type-check --silent >/dev/null 2>&1; then
  echo ""
  echo "âŒ COMMIT BLOCKED: TypeScript errors detected"
  echo ""
  echo "   Fix type errors before committing."
  echo "   Run: npm run type-check (to see errors)"
  echo ""
  echo "   Bypass (emergency only): git commit --no-verify"
  echo ""
  exit 1
fi
echo "   âœ… No TypeScript errors"
echo ""

# Check 3: Linting
echo "ğŸ“‹ Check 3/3: Running ESLint..."
if ! npm run lint --silent >/dev/null 2>&1; then
  echo ""
  echo "âŒ COMMIT BLOCKED: Linting errors detected"
  echo ""
  echo "   Fix linting errors before committing."
  echo "   Run: npm run lint (to see errors)"
  echo "   Run: npm run lint:fix (to auto-fix)"
  echo ""
  echo "   Bypass (emergency only): git commit --no-verify"
  echo ""
  exit 1
fi
echo "   âœ… No linting errors"
echo ""

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… All quality checks passed! Proceeding with commit..."
echo ""

exit 0
